<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="flexible" content="maximum-dpr=3" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
    <title>爱车冲冲冲</title>
    <link rel="stylesheet" href="gaming.css">
    <script src="http://g.tbcdn.cn/mtb/lib-flexible/0.3.2/??flexible_css.js,flexible.js"></script>

</head>

<body>
    <div id="world"></div>
    <div class="combo hidden">
        <p class="combo_count"></p>
    </div>
    <div class="ai hidden">
        <!--         <img class="ai_img" src='res/texture/ai/zidongbiaoji.png'> -->
        <p class="ai_time">10</p>
        <div class="ai_left"></div>
        <div class="ai_right"></div>

    </div>
    <div class="gg msak hidden">
        <button class="close"></button>
        <img src="res/texture/game_over/ggi.png" class="guanggao guanggao_c">
        <iframe src="https://cn.bing.com/" frameborder="0" scrolling='auto' class="hidden web_g guanggao_c"></iframe>
    </div>
    <div class="pause mask hidden">
        <input id="buildingarg">
        <button style="width:99.9972px;height:21.9996px;" onclick="ParseBuildArg()">解析建筑</button>
        <div class="pause_view">
            <!-- <p class="pause_title">游戏暂停</p> -->
            <!-- <img src="res/texture/rank/guanbi.png"  class="close"> -->
            <p class="pause_text">是否放弃本次成绩返回到游戏主页？</p>
            <button class="pause_over pause_btn"></button>
            <button class="pause_again pause_btn"></button>
        </div>
    </div>
    <div class="mask over hidden">
        <div class="over_view">
            <!-- <p class="over_title">本次成绩</p> -->
            <p class="over_score">本场得分：</p>
            <p class="over_best_score">最佳记录：200</p>
            <p class="over_best_rank">目前排行：200</p>
            <button class="pause_btn over_relife" id='over_relife'></button>
            <button class="pause_btn over_over" id='over_over'></button>
            <button class="pause_btn over_again" id='over_again'></button>
        </div>
    </div>
    <div id="control">
        <audio src="res/audio/mu-ui_theme.wav" class="audio_b" loop preload></audio>
        <!-- <audio src="res/audio/ch-he_car_motion-engine_lo.wav" class="audio_run_n" loop preload></audio>
        <audio src="res/audio/ch-he_car_motion-engine_hi.wav" class="audio_run_a" loop preload></audio> -->
        <audio src="res/audio/sc-ev_coin.wav" class="audio_coin" preload></audio>
        <audio src="res/audio/sc-ev_turbo.wav" class="audio_turbo" preload></audio>
        <audio src="res/audio/sc-ev_refuel.wav" class="audio_oil" preload></audio>
        <audio src="res/audio/sc-ev_collide.wav" class="audio_collide" preload></audio>
        <audio src="res/audio/sc-ev_nofuel.wav" class="audio_nofuel" preload></audio>
        <audio src="res/audio/sc-ev_pour.wav" class="audio_pour" preload></audio>
        <audio src="res/audio/ui-bu_ok.wav" class="audio_ok" preload></audio>
        <div class="score_box glod">
            <img src="res/texture/gaming/coin_num.png" class="icon">
            <p class="num glod_num">0</p>
        </div>
        <div class="score_box enery">
            <img src="res/texture/gaming/energy_num.png" class="icon">
            <p class="num enery_num">0</p>
        </div>
        <p class="score score_num">得分：0</p>
        <p class="distance distance_num">0米</p>
        <img src="res/texture/gaming/zt.png" class="zt" onclick="zt()">
        <div class="oil_box">
            <img src="res/texture/gaming/youliang_ico.png" class="oil_icon">
            <p class="oil_num">100 / 100</p>
        </div>

        <div class="move left leftn left_btn"></div>
        <div class="move right rightn right_btn"></div>
    </div>
    <script src="three.min.js"></script>
    <script src="./loaders/FBXLoader.js"></script>
    <script src='dom.js'></script>
    <script src='gaming_dom.js'></script>
    <script type="x-shader/x-vertex" id="uvoffsetvertex">
        uniform vec2 offsetUV;
        uniform vec2 scaleUV;
        uniform vec2 mapSize;
        varying vec2 vUv;
        void main() {
            vUv = uv;
            vec2 offset = offsetUV;
            offset.x *= scaleUV.x/mapSize.x;
            offset.y *= scaleUV.y/mapSize.y;
            vUv.x *= scaleUV.x;
            vUv.y *= scaleUV.y;
            vUv += offset;
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }
    </script>
    <script type="x-shader/x-vertex" id="costomvertex">
        varying vec2 vUv;
        void main() {
            
            vUv = uv;
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }
    </script>

    <script type="x-shader/x-vertex" id="uvanivertex">
        varying vec2 vUv;
        uniform vec4 offsetUV;
        void main() {
            
            vUv = uv;
            vUv.x *= offsetUV.x;
            vUv.y *= offsetUV.y;
            vUv.x += offsetUV.z;
            vUv.y += offsetUV.w;
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }
    </script>

    <script type="x-shader/x-fragment" id="costomfragment">
        varying vec2 vUv;
        uniform sampler2D ColorMap;
        void main() {
            gl_FragColor = texture2D(ColorMap,vUv);
            //gl_FragColor = vec4(1,1,0,1);
        }
    </script>
    <script type="x-shader/x-fragment" id="alphafragment">
        varying vec2 vUv;
        uniform sampler2D ColorMap;
        uniform float Alpha;
        void main() {
            vec4 color = texture2D(ColorMap,vUv);
            color.a *= Alpha;
            gl_FragColor = color;
        }
    </script>
    <script>
        //tools
        /////////////////////////////////////////////////////////////////////////////////////////////
        function ParseBuildArg() {
            var arg = document.getElementById('buildingarg').value;
            alert(arg);
            var json = JSON.parse(arg);
            for (let key in json) {
                if (key != 'key') {
                    window[json.key][key] = json[key];
                }
            }
        }
        function zt() {
            play_audio('audio_ok');
            pause_loop();
            enginePalyPause(false);
            gaming = false;
            show_node('pause');
        }

        ///////////////////////////////////////////////////////////////////////////////////////////
        var ResourceCachedList = {};
        var ResourceCallbakList = {};
        function LoadModel(src, callback) {
            var model = ResourceCachedList[src];
            if (model) {
                callback(model);
            }
            else {
                var call_list = ResourceCallbakList[src];
                if (call_list) {
                    call_list.push(callback);
                }
                else {
                    call_list = [];
                    ResourceCallbakList[src] = call_list;
                    call_list.push(callback);
                    var loader = new THREE.FBXLoader();
                    loader.load(src, function (object) {
                        ResourceCachedList[src] = object;
                        var call = ResourceCallbakList[src];
                        ResourceCallbakList[src] = null;
                        for (var i = 0; i < call.length; i++) {
                            call[i](object);
                        }
                    });
                }

            }

        }
        function LoadTexture(src, callback) {
            var tex = ResourceCachedList[src];
            if (tex) return tex;
            tex = new THREE.TextureLoader().load(src, callback);
            ResourceCachedList[src] = tex;
            tex.magFilter = THREE.LinearFilter;
            tex.minFilter = THREE.LinearFilter;
            tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
            return tex;
        }
        function LoadAudio(src, callback) {
            var buffer = ResourceCachedList[src];
            if (buffer) {
                callback(buffer);
            }
            else {
                var call_list = ResourceCallbakList[src];
                if (call_list) {
                    call_list.push(callback);
                }
                else {
                    call_list = [];
                    ResourceCallbakList[src] = call_list;
                    call_list.push(callback);
                    var loader = new THREE.AudioLoader();
                    loader.load(src, function (buffer) {
                        ResourceCachedList[src] = buffer;
                        var call = ResourceCallbakList[src];
                        ResourceCallbakList[src] = null;
                        for (var i = 0; i < call.length; i++) {
                            call[i](buffer);
                        }
                    });
                }

            }
        }
        function ResourcePreLoad(res_config, callback) {
            var res_list = [];
            function FilterResource(config) {
                for (var key in config) {
                    if (key == "m_Texture") {
                        res_list.push({
                            m_Type: 1,
                            m_Path: config[key]
                        });
                    }
                    else if (key == "m_Model") {
                        res_list.push({
                            m_Type: 2,
                            m_Path: config[key]
                        });
                    }
                    else if (typeof (config[key]) == "object") {
                        FilterResource(config[key]);
                    }
                }

            }
            FilterResource(res_config);
            var load_count = 0;
            for (var i = 0; i < res_list.length; i++) {
                var res = res_list[i];
                if (res.m_Type == 1) {
                    LoadTexture(res.m_Path, () => { load_count++; { callback(load_count / res_list.length) } });
                }
                else if (res.m_Type == 2) {
                    LoadModel(res.m_Path, () => { load_count++; { callback(load_count / res_list.length) } });
                }
            }

        }
        function CleanResourceCache() {
            ResourceCachedList = [];
        }
        ////////////////////////////////////////////////////////////////////////////////////////
        var PositionType = {
            Left: 0,
            Center: 1,
            Right: 2
        }
        var BuildingType = {
            AD: 0,
            Building: 1
        }
        var ItemType = {
            None: 0,
            Gold: 1,
            Car: 2,
            Accelerate: 3,
            Oil: 4,
            Ai: 5

        }

        var clock = [false, false, false, false, false, false, false];
        var GameResConfig = {
            m_Audio: {
                m_EngineHigh: "res/audio/ch-he_car_motion-engine_hi.wav",
                m_EngineLow: "res/audio/ch-he_car_motion-engine_lo.wav"
            },
            m_Background: {
                m_Texture: "res/texture/yuanjing_bg.jpg",
                m_Width: 640,
                m_Height: 960,
                m_PositionOffset: [0, -100, 0]
            },
            m_Road: {
                m_Model: "res/models/road/sa_0330.fbx",
                m_Texture: "res/texture/road/zxz.png",
                m_Width: 14,
                m_Height: 5
            },
            m_Car: {
                m_Model: "res/models/car/car.fbx",
                m_Texture: "res/texture/car/car.jpg",
                m_Width: 2,
                m_Height: 4
            },
            m_EnemyCars: [
                "res/texture/car/car2.png"
            ],
            m_Gold: {
                m_Type: ItemType.Gold,
                m_Texture: "res/texture/item/gold.png",
                m_Size: 1.2,
                m_Height: 155,
            },

            m_Oil: {
                m_Type: ItemType.Oil,
                m_Texture: "res/texture/item/oil.png",
                m_Size: 1.2,
                m_Height: 140,
            },

            m_Ai: {
                m_Type: ItemType.Ai,
                m_Texture: "res/texture/item/zidong_daoju.png",
                m_Size: 1,
                m_Height: 1,
            },

            m_Accelerate: {
                m_Type: ItemType.Accelerate,
                m_Texture: "res/texture/item/jiasu.png",
                m_Size: 1,
                m_Height: 1,
            },
            m_Effect: {
                m_AutoDiver: {
                    m_Texture: "res/texture/ai/zidongbiaoji.png",
                    m_Width: 2,
                    m_Height: 3
                },
                m_Oil: {
                    m_Texture: "res/texture/effect/jiayou_256_h.png",
                    m_Width: 4,
                    m_Height: 4,
                    m_Col: 5,
                    m_Row: 4,
                    m_Loop: false,
                    m_Time: 0.3,
                    m_Count: 20
                },
                m_Gold: {
                    m_Texture: "res/texture/effect/jinbi02_256.png",
                    m_Width: 4,
                    m_Height: 4,
                    m_Col: 4,
                    m_Row: 2,
                    m_Loop: false,
                    m_Time: 0.2,
                    m_Count: 8
                },
                m_CarCrash: {
                    m_Texture: "res/texture/effect/pengzhuang02_256.png",
                    m_Width: 4,
                    m_Height: 4,
                    m_Col: 4,
                    m_Row: 2,
                    m_Loop: false,
                    m_Time: 0.3,
                    m_Count: 8
                },
                m_WeiQi: {
                    m_Texture: "res/texture/effect/weiqi_256_h.png",
                    m_Width: 2,
                    m_Height: 8,
                    m_Col: 3,
                    m_Row: 2,
                    m_Loop: true,
                    m_Time: 0.1,
                    m_Count: 6
                },
                m_ShaBao: {
                    m_Texture: "res/texture/gaming/shabao.png",
                    m_Width: 3,
                    m_Height: 3
                },
                m_Oil: {
                    m_Texture: "res/texture/effect/jiayou_256_h.png",
                    m_Width: 4,
                    m_Height: 4,
                    m_Col: 5,
                    m_Row: 4,
                    m_Loop: false,
                    m_Time: 0.6,
                    m_Count: 20
                }
            },
            m_AD: {
                m_ModelAD: {
                    m_Texture: "res/texture/ad/tiet.png",
                    m_Model: "res/models/ad/ad.fbx"
                },
                m_Plane: [
                    {
                        m_Texture: "res/texture/ad/tianqiao_a.png",
                        m_Width: 25,
                        m_Height: 15,
                        m_Position: PositionType.Center,
                        m_PositionOffset: [0, -1, 0]
                    }
                ]
            },
            m_Buildings: {
                m_Scale: 0.05,
                m_Data: [
                    {
                        m_Type: BuildingType.AD,
                        m_Position: PositionType.Left,
                        m_Texture: "res/texture/building/l_b01.png",
                        m_Width: 256,
                        m_Height: 310,
                        m_PositionOffset: [0, 0, 0]
                    },
                    {
                        m_Type: BuildingType.AD,
                        m_Position: PositionType.Left,
                        m_Texture: "res/texture/building/l_b02.png",
                        m_Width: 277,
                        m_Height: 1112,
                        m_PositionOffset: [0, 0, 0]
                    },
                    {
                        m_Type: BuildingType.AD,
                        m_Position: PositionType.Left,
                        m_Texture: "res/texture/building/l_b03.png",
                        m_Width: 545,
                        m_Height: 428,
                        m_PositionOffset: [0, 0, 0]
                    },
                    {
                        m_Type: BuildingType.AD,
                        m_Position: PositionType.Left,
                        m_Texture: "res/texture/building/l_b04.png",
                        m_Width: 472,
                        m_Height: 651,
                        m_PositionOffset: [0, 0, 0]
                    },
                    {
                        m_Type: BuildingType.AD,
                        m_Position: PositionType.Left,
                        m_Texture: "res/texture/building/l_b05.png",
                        m_Width: 307,
                        m_Height: 693,
                        m_PositionOffset: [0, 0, 0]
                    },
                    {
                        m_Type: BuildingType.AD,
                        m_Position: PositionType.Left,
                        m_Texture: "res/texture/building/l_b06.png",
                        m_Width: 378,
                        m_Height: 293,
                        m_PositionOffset: [0, 0, 0]
                    },
                    {
                        m_Type: BuildingType.AD,
                        m_Position: PositionType.Left,
                        m_Texture: "res/texture/building/l_b07.png",
                        m_Width: 250,
                        m_Height: 585,
                        m_PositionOffset: [0, 0, 0]
                    },
                    {
                        m_Type: BuildingType.AD,
                        m_Position: PositionType.Left,
                        m_Texture: "res/texture/building/l_b08.png",
                        m_Width: 220,
                        m_Height: 740,
                        m_PositionOffset: [0, 0, 0]
                    },
                    {
                        m_Type: BuildingType.AD,
                        m_Position: PositionType.Left,
                        m_Texture: "res/texture/building/l_b09.png",
                        m_Width: 314,
                        m_Height: 680,
                        m_PositionOffset: [0, 0, 0]
                    },
                    {
                        m_Type: BuildingType.AD,
                        m_Position: PositionType.Right,
                        m_Texture: "res/texture/building/r_b01.png",
                        m_Width: 413,
                        m_Height: 359,
                        m_PositionOffset: [0, 0, 0]
                    },
                    {
                        m_Type: BuildingType.AD,
                        m_Position: PositionType.Right,
                        m_Texture: "res/texture/building/r_b02.png",
                        m_Width: 321,
                        m_Height: 375,
                        m_PositionOffset: [0, 0, 0]
                    },
                    {
                        m_Type: BuildingType.AD,
                        m_Position: PositionType.Right,
                        m_Texture: "res/texture/building/r_b03.png",
                        m_Width: 472,
                        m_Height: 413,
                        m_PositionOffset: [0, 0, 0]
                    },
                    {
                        m_Type: BuildingType.AD,
                        m_Position: PositionType.Right,
                        m_Texture: "res/texture/building/r_b04.png",
                        m_Width: 338,
                        m_Height: 598,
                        m_PositionOffset: [0, 0, 0]
                    },
                    {
                        m_Type: BuildingType.AD,
                        m_Position: PositionType.Right,
                        m_Texture: "res/texture/building/r_b05.png",
                        m_Width: 264,
                        m_Height: 1170,
                        m_PositionOffset: [0, 0, 0]
                    }
                ]
            }
        }
        ///////////////////////////////////////////////////////////////////////////////////////
        var GameConfig = {
            m_RoadHeight: 0,
            m_RoadLength: 500,
            m_RoadWidth: 10,
            m_RoadExpandWidth: 16,
            m_BuildingDistance: 10,
            m_EnemyCarSpeed: 50,
            m_CarMaxSpeed: 100,
            m_CarMaxSpeedAc: 200,
            m_CarHorizontalSpeed: 10,
            m_CarAcceleration: 100,
            m_CarPosition: [0, 0, -33],
            m_CameraPosition: [0, 5, -10],
            m_CarCrashSpeedOffset: 100,
            m_CarRoadCount: 3,
            m_MaxOil: 100,
            m_ADDistance: 40,
            m_LongTouchTime: 50,


        }
        ///////////////////////////////////////////////////////////////////////////////////////////
        //item
        var ITME_LIST = {
            time: 5,
            data: [
                [ItemType.Ai, ItemType.Car, ItemType.None],
                [ItemType.Gold, ItemType.None, ItemType.Gold],
                [ItemType.Gold, ItemType.Car, ItemType.None],
                [ItemType.Gold, ItemType.Gold, ItemType.None],
                [ItemType.Car, ItemType.None, ItemType.Gold],
                [ItemType.Gold, ItemType.Gold, ItemType.None],
                [ItemType.None, ItemType.Oil, ItemType.Car],
                [ItemType.None, ItemType.None, ItemType.Accelerate],
            ],
            car_index: 0

        }
        /////////////////////////////////////////////////////////////////////////////////////////////////
        var CacheType = {
            Building: 1,
            Gold: 2,
            Car: 3,
            Accelerate: 4,
            Oil: 5,
            CrashParitcle: 6,
            Ai: 7,
            AD: 8,
        }

        var CACHED_OBJECT = [];

        var PlayScoreCofing = {
            //最大油量
            oil: 100,
            //行进距离
            distance: 1,
            //邮箱加油
            oil_add: 20,

            //油量随里程减少 1/km
            oil_cut: 100,
            //金币加能量
            goldToEnergy: 1,
            //闪避加能量
            dodgeToEnergy: 1,
            //闪避连击加能量
            dodgeComboToEnergy: 1,
            //碰撞减速
            collide: 50,
            //碰撞减少油量
            collideOil: 10,
            //复活次数
            revive: 1,
            //金币得分
            glodScore: 1,
            //移动加分
            remove: 1000,
            //闪避加分
            dodge: 1,
            //闪避连击加分
            dodgeCombo: 1,
            //行进距离加分

            distanceToScore: 1000,
            //难度提升km/s
            speedUp: 2,
            //ai侦测距离
            aiY: 40,
            //ai 时间
            ai_time: 10,
            // ai进行时间
            ai_show_time: 0,
            ai_id: 0,
            //闪避时间
            dodgeTime: 400,

        }

        //钱雨模式
        var money_rain = {
            //持续时间
            time: 10,
            //是否进入模式
            show: false,
            //最大能量值
            max: 100,
            // 进行时间
            show_time: 0
        }

        //加速
        var Accelerate = {
            //持续时间
            time: 10,
            //是否进入模式
            show: false,
            // 进行时间
            show_time: 0,
            acce_id: 0
        }

        //概率
        var Probability = {
            Car: 0.5,
            Glod: 0.5,
            Oil: 0.2,
            Ai: 0.2,
            Accelerate: 0.2
        }

        var palyer_score = {
            distance: 0,
            score: 0,
            enery: 0,
            coin: 0,
            oil: 100,
            dodgeCount: 0,
            crash: false,

        }

        var Glod = {
            p: 0.5,
            y: 10,
            count: 5
        }

        var renderer, scene, camera, audiolistener;
        var HEIGHT, WIDTH;


        //run time data
        var player_car = null;
        var move_left = false;
        var move_right = false;
        var move_forword = true;
        var move_ai = false;
        var ai_drive = false;
        var ai_id = 0;
        var acce_id = 0;
        var gaming = false;
        var long_move = false;
        var dom_ready = false;
        var wx_ready = false;
        var res_ready = false;

        var ai_x = GameConfig.m_RoadWidth / 3;
        var forword_speed = 0;
        var forword_speed_offset = 0;
        var car_move_totle_length = 0;
        var road_material_arg = null;
        var update_last_time = 0;
        //var particle_list = [];
        var left_ad_list = [];
        var enemy_car_list = [];
        var static_item_list = [];
        var item_refresh_time = 0;
        var item_refresh_index = 0;
        var carsh_time_id = null;
        var ad_create_dis = 0;
        var ad_index = 0;
        var sprite_animation_list = [];
        var engine_high_audio = null;
        var engine_low_audio = null;
        var engien_switch_pitch = 0;


        function init() {
            HEIGHT = window.innerHeight;
            WIDTH = window.innerWidth;
            camera = new THREE.PerspectiveCamera(60, WIDTH / HEIGHT, 1, 1000);
            camera.position.set(GameConfig.m_CameraPosition[0], GameConfig.m_CameraPosition[1], GameConfig.m_CameraPosition[2]);
            //camera.rotation.set(-Math.PI * 0.1, 0, 0);
            //camera.position.set(0,5,8);
            audiolistener = new THREE.AudioListener();
            camera.add(audiolistener);
            scene = new THREE.Scene();
            //scene.background = new THREE.Color( 0x050505 );
            renderer = new THREE.WebGLRenderer({
                alpha: true,
                antialias: true,
                precision: 'highp'
            });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(WIDTH, HEIGHT);
            var size = renderer.getSize();
            container = document.getElementById('world');
            container.appendChild(renderer.domElement);
        }
        function createModel(model_url, mat) {
            var mesh = new THREE.Object3D();
            LoadModel(model_url, model => {
                model = model.clone();
                mesh.add(model);
                model.traverse(function (child) {
                    if (child.isMesh) {
                        child.material = mat;
                    }
                });
                mesh.model = model;
            });
            return mesh;
        }
        function setAD(ad, positionType) {
            if (positionType == PositionType.Right) {
                ad.rotation.set(0, -Math.PI * 0.5, 0);
                ad.position.set(GameConfig.m_RoadExpandWidth * 0.5 - 1, 2, 0);
            }
            else {
                ad.rotation.set(0, Math.PI * 0.5, 0);
                ad.position.set(-GameConfig.m_RoadExpandWidth * 0.5 + 1, 2, 0);
            }
        }
        function createAD(res, isCenter) {
            if (!isCenter) {
                var shaderMaterial = new THREE.ShaderMaterial({
                    uniforms: {
                        offsetUV: { value: new THREE.Vector4(1, 1, 0, Math.floor(Math.random() * 2) / 2.0) },
                        ColorMap: { value: LoadTexture(res.m_Texture) }
                    },
                    vertexShader: document.getElementById('uvanivertex').textContent,
                    fragmentShader: document.getElementById('costomfragment').textContent
                });
                var ad = createModel(res.m_Model, shaderMaterial);

                return ad;

            }
            else {
                return createBuilding(res, true)
            }
        }
        function screenToWorldPosition(sx, sy, dis) {
            return new THREE.Vector3(sx, sy, dis / 1000).unproject(camera);
        }
        function createRoad() {
            LoadModel(GameResConfig.m_Road.m_Model, model => {
                var scale = GameConfig.m_RoadLength / GameResConfig.m_Road.m_Height;
                road_material_arg = {
                    mapSize: { value: new THREE.Vector2(1, GameResConfig.m_Road.m_Height) },
                    scaleUV: { value: new THREE.Vector2(1, scale) },
                    offsetUV: { value: new THREE.Vector2(0, 0), type: 'v2' },
                    ColorMap: { value: LoadTexture(GameResConfig.m_Road.m_Texture) }
                };
                var shaderMaterial = new THREE.ShaderMaterial({
                    uniforms: road_material_arg,
                    vertexShader: document.getElementById('uvoffsetvertex').textContent,
                    fragmentShader: document.getElementById('costomfragment').textContent
                });
                model.traverse(function (child) {
                    if (child.isMesh) {
                        child.material = shaderMaterial;
                    }
                });


                var group = new THREE.Object3D();
                group.add(model);
                scene.add(group);
                model.scale.set(1, 1, scale);
                model.rotation.set(0, -Math.PI, 0);
                model.position.set(0, GameConfig.m_RoadHeight, GameConfig.m_RoadLength);
            });
        }
        function createSprite(width, height, src) {
            var sprite_mesh_data = new THREE.PlaneGeometry(width, height, 1, 1);
            var shaderMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    Alpha: { value: 1 },
                    ColorMap: { value: LoadTexture(src) }
                },
                vertexShader: document.getElementById('costomvertex').textContent,
                fragmentShader: document.getElementById('alphafragment').textContent,
                transparent: true
            });
            return new THREE.Mesh(sprite_mesh_data, shaderMaterial);

        }
        function setCarShaBaoEnable(car, enable) {
            if (!car.m_ShaBao) {
                var res = GameResConfig.m_Effect.m_ShaBao;
                var weiqi = createSprite(res.m_Width, res.m_Height, res.m_Texture);
                car.add(weiqi);
                weiqi.rotation.set(0, 0, 0);
                weiqi.position.set(0, res.m_Height * 0.5, 0);
                car.m_ShaBao = weiqi;
            }
            car.m_ShaBao.visible = enable ? true : false;
            if (car.m_CarModel) car.m_CarModel.visible = !enable;
        }
        function setCarCrashEffectEnable(car, enable) {
            if (!car.m_CrashEffect) {
                var res = GameResConfig.m_Effect.m_CarCrash;
                var crash = createSpriteAnimation(res);
                car.add(crash);
                car.m_CrashEffect = crash;
                crash.position.set(0, 1.5, -GameResConfig.m_Car.m_Height * 0.5);
            }
            if (enable) {
                car.m_CrashEffect.visible = true;
                car.m_CrashEffect.animation.m_RunTime = 0;
                car.m_CrashEffect.animation.m_FrameIndex = 1;
            }

        }
        function setAutoDiverEnable(car, enable) {
            if (!car.m_AutoDiver) {
                var res = GameResConfig.m_Effect.m_AutoDiver;
                var crash = createSprite(res.m_Width, res.m_Height, res.m_Texture);
                car.add(crash);
                car.m_AutoDiver = crash;
                crash.position.set(0, 2, -GameResConfig.m_Car.m_Height * 0.5);
            }
            car.m_AutoDiver.visible = enable;
        }
        function setCarOilEffectEnable(car, enable) {
            if (!car.m_OilEffect) {
                var res = GameResConfig.m_Effect.m_Oil;
                var crash = createSpriteAnimation(res);
                car.add(crash);
                car.m_OilEffect = crash;
                crash.position.set(0, 1.5, -GameResConfig.m_Car.m_Height * 0.5);
            }
            if (enable) {
                car.m_OilEffect.visible = true;
                car.m_OilEffect.animation.m_RunTime = 0;
                car.m_OilEffect.animation.m_FrameIndex = 1;
            }

        }
        function setCarGoldffectEnable(car, enable) {
            if (!car.m_GoldEffect) {
                var res = GameResConfig.m_Effect.m_Gold;
                var crash = createSpriteAnimation(res);
                car.add(crash);
                car.m_GoldEffect = crash;
                crash.position.set(0, 1.5, -GameResConfig.m_Car.m_Height * 0.5);
            }
            if (enable) {
                car.m_GoldEffect.visible = true;
                //car.m_GoldEffect.animation.m_RunTime=0;
                //car.m_GoldEffect.animation.m_FrameIndex=1;
            }

        }

        function setCarWeiQiEnable(car, enable) {
            if (!car.m_WeiQiLeft) {
                var res = GameResConfig.m_Effect.m_WeiQi;
                var weiqi = createSpriteAnimation(res);
                car.add(weiqi);
                weiqi.rotation.set(-Math.PI * 0.5, 0, Math.PI);
                weiqi.position.set(-0.5, 0.5, res.m_Height * 0.5 + GameResConfig.m_Car.m_Height * 0.5);
                car.m_WeiQiLeft = weiqi;

                weiqi = createSpriteAnimation(res);
                car.add(weiqi);
                weiqi.rotation.set(-Math.PI * 0.5, 0, Math.PI);
                weiqi.position.set(0.5, 0.5, res.m_Height * 0.5 + GameResConfig.m_Car.m_Height * 0.5);
                car.m_WeiqiRight = weiqi;
            }
            car.m_WeiQiLeft.visible = enable;
            car.m_WeiqiRight.visible = enable;
        }

        function createCar(src, clone_mode) {
            var mesh = new THREE.Object3D();

            LoadModel(GameResConfig.m_Car.m_Model, model => {
                if (clone_mode) model = model.clone();
                var shaderMaterial = new THREE.ShaderMaterial({
                    uniforms: {
                        ColorMap: { value: LoadTexture(src) }
                    },
                    vertexShader: document.getElementById('costomvertex').textContent,
                    fragmentShader: document.getElementById('costomfragment').textContent
                });
                mesh.add(model);
                model.rotation.set(0, -Math.PI * 0.5, 0);
                model.traverse(function (child) {
                    if (child.isMesh) {
                        child.material = shaderMaterial;
                    }
                });
                mesh.m_CarModel = model;
            });

            return mesh;
        }

        function createBuilding(building, isModel) {
            var mesh = new THREE.Object3D();
            var scale = isModel ? 1 : GameResConfig.m_Buildings.m_Scale;
            var width = scale * building.m_Width;
            var height = scale * building.m_Height;
            var geometry = new THREE.PlaneGeometry(width, height, 1, 1);
            var shaderMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    ColorMap: { value: LoadTexture(building.m_Texture) }
                },
                vertexShader: document.getElementById('costomvertex').textContent,
                fragmentShader: document.getElementById('costomfragment').textContent,
                transparent: true
            });
            var model = new THREE.Mesh(geometry, shaderMaterial);
            mesh.add(model);
            if (building.m_Position == PositionType.Left) {
                model.position.set(building.m_PositionOffset[0] - width * 0.5, building.m_PositionOffset[1] + height * 0.5, building.m_PositionOffset[2]);
                mesh.position.set(-GameConfig.m_RoadExpandWidth * 0.5 - 1, -6, -60);
            }
            else if (building.m_Position == PositionType.Right) {
                model.position.set(building.m_PositionOffset[0] + width * 0.5, building.m_PositionOffset[1] + height * 0.5, building.m_PositionOffset[2]);
                mesh.position.set(GameConfig.m_RoadExpandWidth * 0.5 + 1, -6, -60);
            }
            else if (building.m_Position == PositionType.Center) {
                model.position.set(0, building.m_PositionOffset[1] + height * 0.5, building.m_PositionOffset[2]);
                mesh.position.set(0, 0, -60);
            }
            return mesh;
        }
        function createGold() {
            var mesh = new THREE.Object3D();
            var geometry = new THREE.PlaneGeometry(GameResConfig.m_Gold.m_Size, GameResConfig.m_Gold.m_Size, 1, 1);
            var shaderMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    ColorMap: { value: LoadTexture(GameResConfig.m_Gold.m_Texture) }
                },
                vertexShader: document.getElementById('costomvertex').textContent,
                fragmentShader: document.getElementById('costomfragment').textContent,
                transparent: true
            });
            var model = new THREE.Mesh(geometry, shaderMaterial);
            mesh.add(model);
            model.position.set(0, GameResConfig.m_Gold.m_Size * 0.5, 0);
            return mesh;
        }

        function createOil() {
            var mesh = new THREE.Object3D();
            var geometry = new THREE.PlaneGeometry(GameResConfig.m_Oil.m_Size, GameResConfig.m_Oil.m_Size, 1, 1);
            var shaderMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    ColorMap: { value: LoadTexture(GameResConfig.m_Oil.m_Texture) }
                },
                vertexShader: document.getElementById('costomvertex').textContent,
                fragmentShader: document.getElementById('costomfragment').textContent,
                transparent: true
            });
            var model = new THREE.Mesh(geometry, shaderMaterial);
            mesh.add(model);
            model.position.set(0, GameResConfig.m_Oil.m_Size * 0.5, 0);
            return mesh;
        }

        function createProps(ps) {
            var mesh = new THREE.Object3D();
            var geometry = new THREE.PlaneGeometry(GameResConfig[ps].m_Size, GameResConfig[ps].m_Size, 1, 1);
            var shaderMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    ColorMap: { value: LoadTexture(GameResConfig[ps].m_Texture) }
                },
                vertexShader: document.getElementById('costomvertex').textContent,
                fragmentShader: document.getElementById('costomfragment').textContent,
                transparent: true
            });
            var model = new THREE.Mesh(geometry, shaderMaterial);
            mesh.add(model);
            model.position.set(0, GameResConfig[ps].m_Height * 0.5, 0);
            return mesh;
        }

        function createBackground() {
            var sx = GameResConfig.m_Background.m_Width / WIDTH;
            var sy = GameResConfig.m_Background.m_Height / HEIGHT;
            var w1 = screenToWorldPosition((-1 - sx) * 0.5, (-1 - sy) * 0.5, 1000);
            var w2 = screenToWorldPosition((1 + sx) * 0.5, (1 + sy) * 0.5, 1000);
            var geometry = new THREE.PlaneGeometry(w2.x - w1.x, w2.y - w1.y, 1, 1);
            var shaderMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    ColorMap: { value: LoadTexture(GameResConfig.m_Background.m_Texture) }
                },
                vertexShader: document.getElementById('costomvertex').textContent,
                fragmentShader: document.getElementById('costomfragment').textContent
            });
            var model = new THREE.Mesh(geometry, shaderMaterial);
            var offset = new THREE.Vector3(GameResConfig.m_Background.m_PositionOffset[0], GameResConfig.m_Background.m_PositionOffset[1], GameResConfig.m_Background.m_PositionOffset[2])
            model.position.set(offset.x, offset.y, -1000);
            scene.add(model);
        }
        function setAnimationMaterialByIndex(animation, index) {
            var offset = animation.material.uniforms.offsetUV;
            index = index % animation.m_FrameCount;
            var row = Math.floor(index / animation.m_Col);
            var offset_x = (index - row * animation.m_Col) / animation.m_Col;
            var offset_y = row / animation.m_Row;
            //offset.value = new THREE.Vector4(1,1,0,0);
            // offset.value = new THREE.Vector4(offset.value.x,offset.value.y,offset_x,offset_y);
            // console.log(offset);
            offset.value.z = offset_x;
            offset.value.w = offset_y;
        }
        function createSpriteAnimationMaterial(res, col, row, count, time, loop) {
            var animation = {};
            animation.m_FrameCount = count;
            animation.m_Col = col;
            animation.m_Row = row;
            animation.m_Time = time;
            animation.m_Loop = loop;
            animation.m_RunTime = 0;
            animation.m_FrameLength = time / count;
            animation.m_FrameIndex = 0;
            var shaderMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    offsetUV: { value: new THREE.Vector4(1.0 / col, -1.0 / row, 0, 0) },
                    ColorMap: { value: LoadTexture(res) }
                },
                vertexShader: document.getElementById('uvanivertex').textContent,
                fragmentShader: document.getElementById('costomfragment').textContent,
                transparent: true
            });
            animation.material = shaderMaterial;
            return animation;
        }
        function setTestPosition(obj) {
            obj.position.z = -50;
        }
        function createSpriteAnimation(sprite) {
            var geometry = new THREE.PlaneGeometry(sprite.m_Width, sprite.m_Height, 1, 1);
            var animation = createSpriteAnimationMaterial(sprite.m_Texture, sprite.m_Col, sprite.m_Row, sprite.m_Count, sprite.m_Time, sprite.m_Loop);
            var model = new THREE.Mesh(geometry, animation.material);
            model.animation = animation;
            model.position.y += sprite.m_Height * 0.5;
            sprite_animation_list.push(model);
            return model;
        }
        function createEnemyCar() {
            for (var i = 0; i < 3; i++) {
                //var road_start = parseInt(Math.random() * GameConfig.m_RoadLength);
                var car_len = ITME_LIST.data.length;
                var len = GameConfig.m_RoadLength / car_len;
                for (var k = 0; k < car_len; k++) {
                    if (ITME_LIST.data[i][k] == ItemType.Car) {

                        //var z = GameConfig.m_RoadLength % (road_start + k * len);
                        var z = GameConfig.m_RoadLength * 0.6;
                        var cache_data = {
                            m_Res: { m_Texture: GameResConfig.m_EnemyCars[0] },
                            m_Type: CacheType.Car,

                        }
                        var car = getCachedObject(cache_data);
                        car.m_CachedTag = cache_data;
                        car.visible = true;
                        car.PositionType = i;
                        car.position.set((i - 1) * GameConfig.m_RoadWidth / 3, 0, -z);
                        car.m_SpeedOffset = 0;
                        car.m_Type = ItemType.Car;
                        car.x = (i - 1) * GameConfig.m_RoadWidth / 3;
                        scene.add(car);
                        enemy_car_list.push(car);

                    }
                }
            }
        }
        function createPlayerCar() {
            player_car = createCar(GameResConfig.m_Car.m_Texture, true);
            player_car.PositionType = PositionType.Center;
            scene.add(player_car);
            engine_high_audio = new THREE.PositionalAudio(audiolistener);
            engine_low_audio = new THREE.PositionalAudio(audiolistener);
            LoadAudio(GameResConfig.m_Audio.m_EngineHigh, (buffer) => {
                engine_high_audio.setBuffer(buffer);
                engine_high_audio.setLoop(true);
                engine_high_audio.setVolume(0);
                engine_high_audio.play();
            });
            LoadAudio(GameResConfig.m_Audio.m_EngineLow, (buffer) => {
                engine_low_audio.setBuffer(buffer);
                engine_low_audio.setLoop(true);
                engine_high_audio.setVolume(0);
                engine_low_audio.play();
            });
        }



        function getCarSpeed() {
            return forword_speed + forword_speed_offset;
        }
        function getCachedObject(cache_data) {
            var temp = CACHED_OBJECT[cache_data.m_Res.m_Texture];
            if (temp && temp.length > 0) 
            {
                //console.log("return cached object:",cache_data);
                return temp.pop();
            }
            if (cache_data.m_Type == CacheType.Building) return createBuilding(cache_data.m_Res);
            if (cache_data.m_Type == CacheType.Car) return createCar(cache_data.m_Res.m_Texture, true);
            if (cache_data.m_Type == CacheType.Gold) return createGold(cache_data.m_Res.m_Texture);
            if (cache_data.m_Type == CacheType.Oil) return createOil(cache_data.m_Res.m_Texture);
            if (cache_data.m_Type == CacheType.Ai) return createProps('m_Ai', cache_data.m_Res.m_Texture);
            if (cache_data.m_Type == CacheType.Accelerate) {
                return createProps('m_Accelerate', cache_data.m_Res.m_Texture);
            }

            if (cache_data.m_Type == CacheType.AD) return createAD(cache_data.m_Res, cache_data.m_IsCenter);

            if (cache_data.m_Type == CacheType.CrashParitcle) {
                return createSprite(cache_data.m_Res.m_Width, cache_data.m_Res.m_Height, cache_data.m_Res.m_Texture);
            }
            return null;
        }
        function pushCachedObject(obj) {
            obj.visible = false;
            scene.remove(obj);
            var temp = CACHED_OBJECT[obj.m_CachedTag.m_Res.m_Texture];
            if (!temp) {
                temp = [];
                CACHED_OBJECT[obj.m_CachedTag.m_Res.m_Texture] = temp;
            }
            temp.push(obj);
            //console.log("push cached object:",obj.m_CachedTag);
        }
        function chekcRunEnd(obj) {
            //console.log(obj.position.z,player_car.position.z);
            // return (obj.position.z - player_car.position.z) > 10;
            return obj.position.z > 0;
        }
        Math.lerp = function (a, b, t) {
            return a + (b - a) * t;
        }
        function updatePlayerCarEngineAudio(frame, speed) {
            if(money_rain.show){
                return;
            }
            var vol=Math.lerp(0,1,speed/GameConfig.m_CarMaxSpeed);
            if(vol == 0){
                engine_high_audio.setVolume(0);
                engine_low_audio.setVolume(0);
                return;
            }
            var vol_len=10;
            var pitch_time=3;
            engien_switch_pitch+=frame;
            if(engien_switch_pitch>pitch_time)engien_switch_pitch=0;
            var vol2=Math.lerp(0,vol,engien_switch_pitch/pitch_time);
            engine_high_audio.setVolume((vol-vol2)*vol_len);
            engine_low_audio.setVolume(vol2*vol_len);
        }

        function enginePalyPause(play){
            if(play){
                engine_high_audio.play();
                engine_low_audio.play();
            }else{
                engine_high_audio.stop();
                engine_low_audio.stop();
            }
        }

        function updateSpriteAnimation(frame) {
            for (var i = 0; i < sprite_animation_list.length; i++) {
                var sprite = sprite_animation_list[i];
                if (sprite.visible) {
                    var animation = sprite.animation;
                    animation.m_RunTime += frame;
                    if (animation.m_RunTime >= animation.m_FrameLength) {
                        animation.m_RunTime = 0;
                        animation.m_FrameIndex++;
                        if (animation.m_FrameIndex > animation.m_FrameCount) {
                            animation.m_RunTime = 0;
                            animation.m_FrameIndex = 0;
                            sprite.visible = false;
                            continue;
                        }
                        setAnimationMaterialByIndex(animation, animation.m_FrameIndex);

                    }
                }
            }
        }


        function updateFollowCarPosition(frame) {

            var car_speed = getCarSpeed();
            car_move_totle_length += car_speed * frame;
            //update road uv
            if (road_material_arg && move_forword) {
                var d1 = Math.ceil(car_move_totle_length / GameConfig.m_RoadLength);
                var d2 = car_move_totle_length - d1 * GameConfig.m_RoadLength;
                var uv_offset = d2 / GameConfig.m_RoadLength;
                road_material_arg.offsetUV.value = new THREE.Vector2(0, -uv_offset);

            }
            //create ad
            ad_create_dis -= car_speed * frame;
            if (ad_create_dis <= 0) {
                ad_create_dis = GameConfig.m_ADDistance;
                var index = (ad_index++) % 2;
                if (index == 0) {
                    var cache_data = {
                        m_Res: GameResConfig.m_AD.m_Plane[0],
                        m_Type: CacheType.AD,
                        m_IsCenter: true
                    }
                    var ad = getCachedObject(cache_data);
                    ad.m_CachedTag = cache_data;
                    ad.visible = true;
                    ad.position.z = -GameConfig.m_RoadLength;
                    scene.add(ad);
                    left_ad_list.push(ad);
                }
                else {
                    var cache_data = {
                        m_Res: GameResConfig.m_AD.m_ModelAD,
                        m_Type: CacheType.AD
                    }
                    var ad1 = getCachedObject(cache_data);
                    ad1.m_CachedTag = cache_data;
                    var ad2 = getCachedObject(cache_data);
                    ad2.m_CachedTag = cache_data;

                    setAD(ad1, PositionType.Left);
                    setAD(ad2, PositionType.Right);

                    ad1.position.z = -GameConfig.m_RoadLength;
                    scene.add(ad1);
                    left_ad_list.push(ad1);
                    ad2.position.z = -GameConfig.m_RoadLength;
                    scene.add(ad2);
                    left_ad_list.push(ad2);

                }

            }
            //update left_ad
            var temp_left_ad_list = [];
            for (var i = 0; i < left_ad_list.length; i++) {
                var ad = left_ad_list[i];
                ad.position.z += frame * getCarSpeed();
                if (chekcRunEnd(ad)) {
                    pushCachedObject(ad);
                }
                else {
                    temp_left_ad_list.push(ad);
                }
            }
            left_ad_list = temp_left_ad_list;

            //create new left ad
            var create_new_left_ad = left_ad_list.length == 0;
            if (!create_new_left_ad) {
                var ad = left_ad_list[left_ad_list.length - 1];
                if ((GameConfig.m_RoadLength + ad.position.z) > GameConfig.m_BuildingDistance) {
                    create_new_left_ad = true;
                }
            }
            if (create_new_left_ad) {
                var index = parseInt(Math.random() * GameResConfig.m_Buildings.m_Data.length);
                var cache_data = {
                    m_Res: GameResConfig.m_Buildings.m_Data[index],
                    m_Type: CacheType.Building,

                }
                var ad = getCachedObject(cache_data);
                ad.m_CachedTag = cache_data;
                ad.visible = true;
                left_ad_list.push(ad);
                ad.position.z = -GameConfig.m_RoadLength;
                scene.add(ad);
            }
            //update static item
            var temp_static_item = [];
            //console.log(static_item_list.length, 'len');
            for (var i = 0; i < static_item_list.length; i++) {
                var item = static_item_list[i];
                //console.log(item); && item.leng
                item.position.z += frame * getCarSpeed();
                if (chekcRunEnd(item)) {
                    pushCachedObject(item);
                }
                else if(!eat_coin(item)){
                    temp_static_item.push(item);
                }
                // else {


                //     //console.log(item,item.position.z);
                //     item.position.z += frame * getCarSpeed();
                //     if (chekcRunEnd(item)) {
                //         //console.log('end',item.position.x);
                //         pushCachedObject(item);

                //     }
                //     else {
                //         temp_static_item.push(item);
                //     }

                // }
            }
            static_item_list = temp_static_item;

            //effect
            // var temp_paritcle_list = [];
            // for (var i = 0; i < particle_list.length; i++) {
            //     var p = particle_list[i];
            //     p.position.z += frame * getCarSpeed();
            //     if (chekcRunEnd(p)) {
            //         //console.log('end',item.position.x);
            //         pushCachedObject(p);

            //     }
            //     else {
            //         temp_static_item.push(p);
            //         p.material.uniforms.Alpha = Math.lerp(1, 0, (-p.position.z / GameConfig.m_CameraPosition[2]));
            //     }
            // }
            // particle_list = temp_paritcle_list;

        }

        function eat_coin(item) {
            //吃金币
            if ((player_car.position.z > item.position.z)
                && Math.abs(player_car.position.x - item.position.x) < GameResConfig.m_Car.m_Width
                && Math.abs(player_car.position.z - item.position.z) < GameResConfig.m_Car.m_Height) {
                console.log('eat');


                if (window.clock[item.m_Type]) {
                    return;
                } else {
                    clock_item(item.m_Type);
                }
                if (item.m_Type == ItemType.Gold) {
                    play_audio('audio_coin');
                    item.visible = false;
                    this.add_coin(item.rain);
                    pushCachedObject(item);
                    setCarGoldffectEnable(player_car, true);
                    return true;
                } else if (item.m_Type == ItemType.Oil) {
                    play_audio('audio_oil');
                    pushCachedObject(item);
                    this.add_oil(PlayScoreCofing.oil_add);
                    setCarOilEffectEnable(player_car, true);
                    return true;
                } else if (item.m_Type == ItemType.Ai) {
                    ai_drive = true;

                    show_ai();
                    setAutoDiverEnable(player_car, true);
                    window.clearTimeout(PlayScoreCofing.ai_id);
                    PlayScoreCofing.ai_show_time = 0;
                    // ai_id = setTimeout(() => {
                    //     setAutoDiverEnable(player_car, false);
                    //     hidden_ai();
                    //     ai_drive = false;
                    // }, PlayScoreCofing.ai_time * 1000);
                    // time_out(PlayScoreCofing.ai_id, PlayScoreCofing.ai_show_time, PlayScoreCofing.ai_time, () => {
                    //     setAutoDiverEnable(player_car, false);
                    //     hidden_ai();
                    //     ai_drive = false;
                    // })
                    pushCachedObject(item);
                    return true;
                } else if (item.m_Type == ItemType.Accelerate) {
                    play_audio('audio_turbo');
                    Accelerate.show = true;
                    forword_speed = GameConfig.m_CarMaxSpeedAc;

                    window.clearTimeout(Accelerate.acce_id);
                    Accelerate.show_time = 0;
                    acce_id = setTimeout(() => {
                        Accelerate.show = false;

                    }, Accelerate.time * 1000);

                    pushCachedObject(item);
                    return true;
                }
            }
            return false;
        }

        function time_out(id, time, end, cb) {
            id = setTimeout(() => {
                if (gaming) {
                    time += 1;
                }
                if (time < end) {
                    time_out(id, time, end, cb);
                } else {
                    time = 0;
                    cb();
                }
            }, 1000)
        }

        function clock_item(index) {
            if (money_rain.show) {
                return;
            }
            window.clock[index] = true;
            setTimeout(() => {
                window.clock[index] = false;
            }, 40)
        }

        function update(frame) {
            if (!gaming) {
                return;
            }

            if (palyer_score.oil <= 0) {
                //move_forword = false;
                gaming = false;
                set_score();
                pause_loop();
                if (PlayScoreCofing.revive <= 0) {
                    set_revive_gray();
                }
                show_node('over');

            }
            //update sprite animation
            updateSpriteAnimation(frame);
            //update car
            if (player_car) {
                this.carMove(frame);
                if (forword_speed < GameConfig.m_CarMaxSpeed) {
                    //play_engine('audio_run_n');
                    if (move_forword) forword_speed += GameConfig.m_CarAcceleration * frame;
                    else if (forword_speed > 0) forword_speed -= GameConfig.m_CarAcceleration * frame;
                    var s = (GameConfig.m_CarMaxSpeed * GameConfig.m_CarMaxSpeed - forword_speed * forword_speed) * 0.5 / GameConfig.m_CarAcceleration;
                    player_car.position.z = GameConfig.m_CarPosition[2] + s * 0.02;
                }
                else if (forword_speed > GameConfig.m_CarMaxSpeed) {
                    if (!Accelerate.show) {
                        if (move_forword) forword_speed -= GameConfig.m_CarAcceleration * frame;
                        else if (forword_speed > 0) forword_speed += GameConfig.m_CarAcceleration * frame;
                        var s = (GameConfig.m_CarMaxSpeedAc * GameConfig.m_CarMaxSpeedAc - forword_speed * forword_speed) * 0.5 / GameConfig.m_CarAcceleration;
                        player_car.position.z = GameConfig.m_CarPosition[2] - s * 0.02;
                    }

                } else {
                    player_car.position.z = GameConfig.m_CarPosition[2];
                    forword_speed = GameConfig.m_CarMaxSpeed;
                }
                if (!Accelerate.show && forword_speed > GameConfig.m_CarMaxSpeed) {
                    if (move_forword) forword_speed -= GameConfig.m_CarAcceleration * frame;
                    else if (forword_speed > 0) forword_speed += GameConfig.m_CarAcceleration * frame;
                    var s = (GameConfig.m_CarMaxSpeedAc * GameConfig.m_CarMaxSpeedAc - forword_speed * forword_speed) * 0.5 / GameConfig.m_CarAcceleration;
                    player_car.position.z = GameConfig.m_CarPosition[2] - s * 0.02;
                }

                setCarWeiQiEnable(player_car, move_forword);
                updatePlayerCarEngineAudio(frame, forword_speed);
            }
            if (forword_speed_offset != 0) {
                forword_speed_offset = Math.lerp(forword_speed_offset, 0, frame);
            }

            if (move_forword) {
                updateFollowCarPosition(frame);
                var f = frame > 0.17 ? 0.16 : frame;
                this.add_distance(frame * getCarSpeed());
            }


            //update enemy car
            var temp_car_list = [...enemy_car_list];
            var enery_len = enemy_car_list.length;

            for (var i = 0; i < enery_len; i++) {
                var item = enemy_car_list[i];

                var self_seepd = GameConfig.m_EnemyCarSpeed + item.m_SpeedOffset;
                var player_speed = move_forword ? getCarSpeed() : 0;
                var speed = self_seepd - player_speed;
                item.position.z -= frame * speed;
                //console.log('car',frame * speed);
                // if (Accelerate.show) {

                //     setCarShaBaoEnable(item, item.m_Crash);
                //     if (item.m_Crash) {
                //         if (item.m_SpeedOffset > 0) {
                //             item.m_SpeedOffset = Math.lerp(item.m_SpeedOffset, 0, 0.2);
                //         }
                //         if (item.m_SpeedOffset == 0) {
                //             pushCachedObject(item);
                //             item.m_Crash = false;
                //         }
                //         continue;
                //     }
                // }
                // if (item.x != item.position.x) {
                //     item.position.x += GameConfig.m_CarHorizontalSpeed * frame * item.direction;
                //     if (item.direction > 0 && item.position.x > item.x) {
                //         item.position.x = item.x
                //     } else if (item.direction < 0 && item.position.x < item.x) {
                //         item.position.x = item.x
                //     }

                // }

                if (!move_ai && Math.abs(player_car.position.x - item.position.x) < GameResConfig.m_Car.m_Width && Math.abs(item.position.z - player_car.position.z) < (PlayScoreCofing.aiY * frame * Math.abs(speed))) {
                    if (ai_drive) {
                        //console.log('move_ai');
                        move_ai = true;
                        var car_ran_pst = 1;
                        if (player_car.position.x > 1) {
                            car_ran_pst = -1;
                        } else if (player_car.position.x < -1) {
                            car_ran_pst = 1;
                        } else {
                            car_ran_pst = Math.random() > 0.5 ? 1 : -1;
                            if (enemy_car_list[i + 1] && (enemy_car_list[i + 1].position.x / car_ran_pst) > 0) {
                                car_ran_pst *= -1;
                            }
                        }
                        if (car_ran_pst > 0) {
                            move_right = true;
                            move_left = false;
                        } else {
                            move_right = false;
                            move_left = true;
                        }
                        player_car.PositionType += car_ran_pst;
                        player_car.PositionType += 30;
                        player_car.PositionType %= 3;
                        ai_x = (player_car.PositionType - 1) * (GameConfig.m_RoadWidth / 3);
                    }
                    will_carsh();

                }

                if (item.position.z < -GameConfig.m_RoadLength) {
                    pushCachedObject(item);
                    temp_car_list.splice(i, 1);
                    //item.position.z += GameConfig.m_RoadLength;
                    //console.log('zzzzzz');
                }
                else if (item.position.z > 0) {
                    //console.log('push');
                    pushCachedObject(item);
                    temp_car_list.splice(i, 1);
                    //item.position.z -= GameConfig.m_RoadLength;
                    //item.PositionType = Math.floor(Math.random()*3);
                    //item.position.x = item.x = GameConfig.m_RoadWidth / 3 * (item.PositionType - 1);
                    //console.log(item.position.x,item.x);
                }
                else if ((player_car.position.z > item.position.z)
                    && Math.abs(player_car.position.x - item.position.x) < GameResConfig.m_Car.m_Width) {
                    //pushCachedObject(item);
                    if (Math.abs(player_car.position.z - item.position.z) < GameResConfig.m_Car.m_Height) {

                        //console.log('carsh', player_car.position.x, item.position.x)


                        item.m_Crash = true;
                        item.m_SpeedOffset = GameConfig.m_CarCrashSpeedOffset;
                        // var x = item.position.x, po = 1;
                        // if (x < 0) {
                        //     po = 1;
                        // } else if (x > 0) {
                        //     po = -1;
                        // } else if (Math.random() > 0.5) {
                        //     po = -1;
                        // } else {
                        //     po = 1;
                        // }
                        // item.PositionType += po;
                        // item.x_start = x;
                        // item.direction = po;
                        // item.x = x + GameConfig.m_RoadWidth / 3 * po;
                        if (Accelerate.show) {
                            Accelerate.show = false;
                        }
                        play_audio('audio_collide');
                        palyer_score.carsh = true;
                        //console.log(new Date(),'carsh',palyer_score.carsh);
                        forword_speed -= GameConfig.m_CarCrashSpeedOffset;
                        forword_speed = Math.max(forword_speed, 0);
                        this.update_oil(-PlayScoreCofing.collideOil);
                        ///////////////////////////////////////////////////
                        //crash effect
                        // var cache_data = {

                        //     m_Res: GameResConfig.m_Effect.m_CarCrash,
                        //     m_Type: CacheType.CrashParitcle

                        // }
                        // var particle = getCachedObject(cache_data);
                        // particle.m_CachedTag = cache_data;
                        // scene.add(particle);
                        // particle.position.set(item.position.x, item.position.y, item.position.z);
                        // particle_list.push(particle);
                        setCarCrashEffectEnable(player_car, true);
                    }

                }
            }
            enemy_car_list = temp_car_list;
            if (move_forword) {
                item_refresh_time += frame;
                if (item_refresh_time > (ITME_LIST.time / ITME_LIST.data.length)) {
                    item_refresh_time = 0;
                    var group = ITME_LIST.data[item_refresh_index];
                    for (var i = 0; i < group.length; i++) {
                        if (money_rain.show) {
                            for (var rain = 0; rain < 3; rain++) {
                                for (let j = 0; j < Glod.count; j++) {
                                    var cache_data = {
                                        m_Res: { m_Texture: GameResConfig.m_Gold.m_Texture },
                                        m_Type: CacheType.Gold,

                                    }
                                    var gold = getCachedObject(cache_data);
                                    gold.m_CachedTag = cache_data;
                                    gold.visible = true;
                                    gold.position.set((i - 1) * GameConfig.m_RoadWidth / 3, 0, -GameConfig.m_RoadLength + j * Glod.y);
                                    gold.m_Type = ItemType.Gold;
                                    gold.rain = true;
                                    scene.add(gold);
                                    static_item_list.push(gold);
                                }
                                
                            }
                        } else {

                            var type = group[i];
                            if (type == ItemType.Car && Math.random() < Probability.Car) {
                                var cache_data = {
                                    m_Res: { m_Texture: GameResConfig.m_EnemyCars[0] },
                                    m_Type: CacheType.Car,

                                }
                                var car = getCachedObject(cache_data);
                                car.m_CachedTag = cache_data;
                                car.visible = true;
                                car.position.set((i - 1) * GameConfig.m_RoadWidth / 3, 0, -GameConfig.m_RoadLength);
                                car.PositionType = i;
                                car.m_SpeedOffset = 0;
                                car.m_Type = ItemType.Car;
                                car.x = (i - 1) * GameConfig.m_RoadWidth / 3;
                                scene.add(car);
                                enemy_car_list.push(car);
                            }
                            else if (type == ItemType.Gold && Math.random() < Probability.Glod) {
                                for (let j = 0; j < Glod.count; j++) {

                                    var cache_data = {
                                        m_Res: { m_Texture: GameResConfig.m_Gold.m_Texture },
                                        m_Type: CacheType.Gold,

                                    }
                                    var gold = getCachedObject(cache_data);
                                    gold.m_CachedTag = cache_data;
                                    gold.visible = true;
                                    
                                    gold.position.set((i - 1) * GameConfig.m_RoadWidth / 3, 0, -GameConfig.m_RoadLength + j * Glod.y);
                                    gold.m_Type = ItemType.Gold;
                                    gold.rain = false;
                                    scene.add(gold);
                                    static_item_list.push(gold);
                                }
                                

                            } else if (type == ItemType.Oil && Math.random() < Probability.Oil) {
                                var cache_data = {
                                    m_Res: { m_Texture: GameResConfig.m_Oil.m_Texture },
                                    m_Type: CacheType.Oil,

                                }
                                var oil = getCachedObject(cache_data);
                                oil.m_CachedTag = cache_data;
                                oil.visible = true;
                                oil.position.set((Math.floor(Math.random() * 3) - 1) * GameConfig.m_RoadWidth / 3, 0, -GameConfig.m_RoadLength);

                                oil.m_Type = ItemType.Oil;
                                scene.add(oil);
                                static_item_list.push(oil);
                            } else if (type == ItemType.Ai && Math.random() < Probability.Ai) {
                                var cache_data = {
                                    m_Res: { m_Texture: GameResConfig.m_Ai.m_Texture },
                                    m_Type: CacheType.Ai,

                                }
                                var Ai = getCachedObject(cache_data);
                                Ai.m_CachedTag = cache_data;
                                Ai.visible = true;
                                Ai.position.set((Math.floor(Math.random() * 3) - 1) * GameConfig.m_RoadWidth / 3, 0, -GameConfig.m_RoadLength);

                                Ai.m_Type = ItemType.Ai;
                                scene.add(Ai);
                                static_item_list.push(Ai);
                            } else if (type == ItemType.Accelerate && Math.random() < Probability.Accelerate) {
                                var cache_data = {
                                    m_Res: { m_Texture: GameResConfig.m_Accelerate.m_Texture },
                                    m_Type: CacheType.Accelerate,

                                }
                                var Ac = getCachedObject(cache_data);
                                Ac.m_CachedTag = cache_data;
                                Ac.visible = true;
                                Ac.position.set((Math.floor(Math.random() * 3) - 1) * GameConfig.m_RoadWidth / 3, 0, -GameConfig.m_RoadLength);

                                Ac.m_Type = ItemType.Accelerate;
                                scene.add(Ac);
                                static_item_list.push(Ac);
                            }

                        }
                        //item_refresh_index = (item_refresh_index + 1) % ITME_LIST.data.length;
                        item_refresh_index = Math.floor((Math.random() * ITME_LIST.data.length));
                    }
                }
            }
        }
        function loop(time) {
            update((time - update_last_time) * 0.001);
            update_last_time = time;
            // 渲染场景
            renderer.render(scene, camera);
            // 重新调用 render() 函数
            requestAnimationFrame(loop);
        }
        function RigisterEvent() {
            set_pause();
            set_over();
            set_gaunggao();
            document.addEventListener('keydown', onDocumentKeyDown);
            document.addEventListener('keyup', onDocumentKeyUp);
            // document.addEventListener( 'mousedown', onDocumentMouseDown );
            // document.addEventListener( 'mouseup', onDocumentMouseUp );
            // document.addEventListener( 'mousemove', onDocumentMouseMove );

            //document.addEventListener( 'touchstart', onDocumentTouchStart );
            //document.addEventListener( 'touchend', onDocumentTouchEnd );
            //document.addEventListener( 'touchmove', onDocumentTouchMove );
            this.setMoveHandle('left');
            this.setMoveHandle('right');
        }
        function onDocumentTouchStart(event) {
            if (event.clientY > HEIGHT / 2) {
                if (event.clientX < WIDTH / 2) move_left = true;
                else move_right = true;
            }
        }
        function onDocumentTouchEnd(event) {
            move_left = false;
            move_right = false;
        }
        function onDocumentTouchMove(event) {

        }
        function onDocumentMouseDown(event) {
            console.log(event);
            if (event.clientY > HEIGHT / 2) {
                if (event.clientX < WIDTH / 2) move_left = true;
                else move_right = true;
            }
        }
        function onDocumentMouseUp(event) {
            //console.log(event);
            move_left = false;
            move_right = false;
        }
        function onDocumentMouseMove(event) {
            //console.log(event);
        }
        function onDocumentKeyDown(event) {
            if (event.key == 'a') {
                move_left = true;
            }
            else if (event.key == 'd') {
                move_right = true;
            }
            else if (event.key == 'w') {
                move_forword = true;
            }
        }
        function onDocumentKeyUp(event) {
            if (event.key == 'a') {
                move_left = false;
            }
            else if (event.key == 'd') {
                move_right = false;
            }
            else if (event.key == 'w') {
                move_forword = false;
                forword_speed -= 0.1;
            }
        }

        /**
         * name  class 
         * position -1 left ; 1 right 
         */
        function setMoveHandle(name) {
            var node = document.getElementsByClassName(name)[0];
            var time_id = null, move = false;
            node.addEventListener('touchstart', () => {
                if (!ai_drive) {
                    replace_node(name + 'n', name + 'a', name);
                    time_id = setTimeout(() => {
                        //console.log('long');
                        if (name == 'right') {
                            move_right = true;
                            move_left = false;
                        } else {
                            move_left = true;
                            move_right = false;
                        }
                        long_move = true;
                    }, GameConfig.m_LongTouchTime);
                }
            });

            node.addEventListener('touchmove', () => {
                if (!ai_drive) {
                    move = true;
                }
            });

            node.addEventListener('touchend', () => {
                if (!ai_drive) {
                    replace_node(name + 'a', name + 'n', name);
                    long_move = false;
                    clearTimeout(time_id);
                    if (move) {
                        move = move_left = move_right = false;
                        ai_x = GameConfig.m_RoadWidth / 3;

                    } else {
                        //console.log('single');
                        if (name == 'right') {
                            move_right = true;
                            move_left = false;
                            player_car.PositionType += 1;

                        } else {
                            move_left = true;
                            move_right = false;
                            player_car.PositionType -= 1;
                        }
                        player_car.PositionType = THREE.Math.clamp(player_car.PositionType, 0, 2);
                        ai_x = (GameConfig.m_RoadWidth) / 3 * (player_car.PositionType - 1);
                        //console.log('single', 'left', move_left, 'right', move_right, player_car.PositionType);
                    }
                }
            });
        }

        function carMove(frame) {
            var pst = 0, car_t = player_car.PositionType - 1;
            var GCW = GameConfig.m_RoadWidth / 3;
            if (move_left) {
                pst = -1;
                if (move_ai && player_car.position.x <= car_t * GCW) {
                    //player_car.position.x = car_t * GCW;
                    //console.log('left false', car_t, player_car.position.x, player_car.PositionType);
                    move_ai = false;
                    move_left = false;
                } else {
                    //console.log(move_ai,player_car.position.x,car_t,ai_x);
                }
            }
            if (move_right) {
                pst = 1;
                //console.log(car_t);
                if (move_ai && player_car.position.x >= car_t * GCW) {
                    //console.log('right false', car_t, player_car.position.x, player_car.PositionType);
                    //player_car.position.x = car_t * GCW;
                    move_ai = false;
                    move_right = false;
                }
            }



            if (long_move) {
                player_car.position.x += GameConfig.m_CarHorizontalSpeed * frame * pst;
                player_car.position.x = THREE.Math.clamp(player_car.position.x, -GameConfig.m_RoadWidth / 3, GameConfig.m_RoadWidth / 3);
                var pt = player_car.position.x / (GameConfig.m_RoadWidth / 6);
                if (pt > 0) {
                    pt = Math.floor(pt);
                } else {
                    pt = Math.ceil(pt);
                }
                pt = (pt == -0) ? 0 : pt;
                //console.log('long');
                player_car.PositionType = pt + 1;
            } else if (player_car.position.x != ai_x) {
                //console.log('single_move', player_car.position.x, ai_x, move_left);
                var x = player_car.position.x + GameConfig.m_CarHorizontalSpeed * frame * pst;
                if ((pst > 0 && x > ai_x) || (pst < 0 && x < ai_x)) {
                    //console.log('------', x, ai_x, pst)
                    x = ai_x;
                } else {
                    //console.log(x, ai_x, pst)
                }
                player_car.position.x = x;
                //player_car.position.x = THREE.Math.clamp(player_car.position.x, min, max);

            } else {
                //console.log('aix', ai_x);
                move_left = false;
                move_right = false;
                ai_x = GameConfig.m_RoadWidth / 3;
            }
        }

        function will_carsh() {
            if (!carsh_time_id) {
                //console.log('ssssssssss');
                carsh_time_id = setTimeout(() => {
                    //console.log(new Date(),'eee',palyer_score.carsh);
                    //console.log(carsh_time_id);
                    if (!palyer_score.carsh) {
                        //console.log('dodge');
                        palyer_score.dodgeCount++;
                        this.add_score(PlayScoreCofing.dodge);
                        //set_combo(palyer_score.dodgeCount);
                    } else {
                        palyer_score.carsh = false;
                        //console.log('no dodge');
                    }
                    setTimeout(() => {
                        carsh_time_id = null;
                    }, 150)
                }, PlayScoreCofing.dodgeTime)
            }

        }

        function set_palyer_score(name, value) {
            document.getElementsByClassName(name)[0].innerHTML = value;
        }

        function add_coin(rain) {
            palyer_score.coin += 1;
            this.set_palyer_score('glod_num', palyer_score.coin);
            this.add_score(PlayScoreCofing.glodScore);
            this.add_enery(PlayScoreCofing.goldToEnergy, rain);
        }

        function add_score(value) {
            palyer_score.score += value;
            var text = '得分：' + palyer_score.score;
            this.set_palyer_score('score_num', text);
        }

        function add_enery(value, rain) {

            if (!money_rain.show && !rain) {

                palyer_score.enery += value;
                //console.log('add',value);
                this.set_palyer_score('enery_num', palyer_score.enery);
                if (palyer_score.enery == money_rain.max) {
                    money_rain.show = true;
                    enemy_car_list.forEach(temp => {
                        pushCachedObject(temp);

                    })
                    setTimeout(() => {
                        show_money_rain()
                    }, 4000);

                }
            }
        }
        function show_money_rain() {

            //
            setTimeout(() => {
                //console.log(palyer_score.enery);
                if (gaming) {

                    palyer_score.enery -= 1;
                }
                if (palyer_score.enery < 0) {
                    palyer_score.enery = 0;

                    this.clear_temp();
                    static_item_list = [];
                    setTimeout(() => {
                        money_rain.show = false;
                    }, 0);
                } else {
                    this.set_palyer_score('enery_num', palyer_score.enery);
                    //play_audio('audio_pour');
                    show_money_rain();
                }
                //console.log(palyer_score.enery,money_rain.show);
            }, 100)

        }

        function clear_temp() {
            static_item_list.forEach(temp => {
                if (Array.isArray(temp)) {
                    temp.forEach(t => {
                        pushCachedObject(t);
                    })
                } else {
                    pushCachedObject(temp);
                }
            })
        }

        function add_distance(value) {

            if (Math.random() > 0.5) {
                value = Math.ceil(value);
            } else {
                value = Math.floor(value);
            }
            palyer_score.distance += value * PlayScoreCofing.distance;
            var now_value = parseInt(document.getElementsByClassName('distance_num')[0].innerHTML);
            if (palyer_score.distance > (now_value + 10)) {
                if ((palyer_score.distance % 1000) < 12) {
                    this.add_score(PlayScoreCofing.distanceToScore);
                }
                var text = palyer_score.distance + '米';
                this.set_palyer_score('distance_num', text);

                this.update_oil(-(palyer_score.distance - now_value) / PlayScoreCofing.oil_cut);
            }
        }

        function update_oil(value) {
            if (Accelerate.show) {
                return;
            }
            palyer_score.oil += value;
            palyer_score.oil = Math.max(palyer_score.oil, 0);
            var now_oil = parseInt(document.getElementsByClassName('oil_num')[0].innerHTML);
            if (palyer_score.oil <= (now_oil - 1)) {
                this.set_palyer_score('oil_num', Math.ceil(palyer_score.oil) + ' / 100');
                update_oil_img(palyer_score.oil);
                if (Math.ceil(palyer_score.oil) == 20) {
                    play_audio('audio_nofuel');
                }
            }
        }

        function add_oil(value) {
            palyer_score.oil += value;
            palyer_score.oil = Math.min(palyer_score.oil, PlayScoreCofing.oil);
            this.set_palyer_score('oil_num', Math.ceil(palyer_score.oil) + ' / 100');
            update_oil_img(palyer_score.oil);
        }
        ResourcePreLoad(GameResConfig, function (progress) {
            console.log("resource loaded:" + progress);
            if (progress === 1) {
                init();
                RigisterEvent();
                loop(0);
                createBackground();
                createRoad();
                createEnemyCar();
                createPlayerCar();
                res_ready = true;
                check_ready();
            }

        })
        play_audio_main();
        window.onload = function () {
            dom_ready = true;
            console.log('dom _check');
            check_ready();
        }

        function check_ready() {
            if (dom_ready && wx_ready && res_ready) {
                gaming = true;
            }
        }

    </script>
</body>

</html>