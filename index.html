<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
            #world {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(#e4e0ba, #f7d9aa);
        }
        #control{
            position: absolute;
            z-index: 2;
            width: 100%;
            height: 100%;
            text-align:center;
        }
        button{
            margin-top: 100%;
            width: 20%;
            height: 50px;
        }
    </style>
</head>
<body>
    <div id="world"></div>
    <div id="control">
        <input id="buildingarg"><a style="width:100px;height:22px;" href="#" onclick="ParseBuildArg()">解析建筑</a>
        <!-- <button style="margin-right:150px;" hover="Hover(0);">Left</button>
        <button >Right</button> -->
    </div>
    <script src="three.min.js"></script>
    <script src="./loaders/FBXLoader.js"></script>
    <script type="x-shader/x-vertex" id="uvoffsetvertex">
        uniform vec2 offsetUV;
        uniform vec2 scaleUV;
        uniform vec2 mapSize;
        varying vec2 vUv;
        void main() {
            vUv = uv;
            vec2 offset = offsetUV;
            offset.x *= scaleUV.x/mapSize.x;
            offset.y *= scaleUV.y/mapSize.y;
            vUv.x *= scaleUV.x;
            vUv.y *= scaleUV.y;
            vUv += offset;
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }
    </script>
    <script type="x-shader/x-vertex" id="costomvertex">
        varying vec2 vUv;
        void main() {
            
            vUv = uv;
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }
    </script>

    <script type="x-shader/x-fragment" id="costomfragment">
        varying vec2 vUv;
        uniform sampler2D ColorMap;
        void main() {
            gl_FragColor = texture2D(ColorMap,vUv);
            //gl_FragColor = vec4(1,1,0,1);
        }
    </script>
    <script>
        //tools
        /////////////////////////////////////////////////////////////////////////////////////////////
        function ParseBuildArg(){
            var arg = document.getElementById('buildingarg').value;
            alert(arg);
            GameResConfig.m_Buildings=JSON.parse(arg);
        }
        ///////////////////////////////////////////////////////////////////////////////////////////
        var ResourceCachedList={};
        var ResourceCallbakList={};
        function LoadModel(src,callback){
            var model=ResourceCachedList[src];
            if(model){
                callback(model);
            }
            else{
                var call_list=ResourceCallbakList[src];
                if(call_list){
                    call_list.push(callback);
                }
                else{
                    call_list=[];
                    ResourceCallbakList[src]=call_list;
                    call_list.push(callback);
                    var loader = new THREE.FBXLoader();
                    loader.load(src, function ( object ) {
                        ResourceCachedList[src]=object;
                        var  call=ResourceCallbakList[src];
                        ResourceCallbakList[src]=null;
                        for(var i=0;i<call.length;i++){
                            call[i](object);
                        }
                    } );
                }
                
            }

        }
        function LoadTexture(src){
            var tex=ResourceCachedList[src];
            if(tex)return tex;
            tex =  new THREE.TextureLoader().load(src);
            ResourceCachedList[src]=tex;
            tex.magFilter = THREE.LinearFilter; 
            tex.minFilter = THREE.LinearFilter; 
            tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
            return tex;
        }
        function CleanResourceCache(){
            ResourceCachedList=[];
        }
        ////////////////////////////////////////////////////////////////////////////////////////
        var PositionType={
            Left:0,
            Center:1,
            Right:2
        }
        var BuildingType={
            AD:0,
            Building:1
        }
        var ItemType={
            None:0,
            Gold:1,
            Car:2
        }
        var GameResConfig={
            m_Background:{
                m_Texture:"res/texture/background.png",
                m_Width:500,
                m_Height:800,
                m_PositionOffset:[0,-60,0]
            },
            m_Road:{
                m_Model:"res/models/road/dx_005.fbx",
                m_Texture:"res/texture/road/dx_001_min.png",
                m_Width:14,
                m_Height:5
            },
            m_Car:{
                m_Model:"res/models/car/player_car.fbx",
                m_Texture:"res/texture/car/player_car.png",
                m_Width:2,
                m_Height:4
            },
            m_EnemyCars:[
                "res/texture/car/car2.png"
            ],
            m_Gold:{
                m_Type:ItemType.Gold,
                m_Texture:"res/texture/item/gold.jpg",
                m_Size:4
            },
            m_Buildings:{
                m_Scale:0.05,
                m_Data:[
                    {
                        m_Type:BuildingType.AD,
                        m_Position:PositionType.Left,
                        m_Texture:"res/texture/building/l_b01.png",
                        m_Width:256,
                        m_Height:310,
                        m_PositionOffset:[0,0,0]
                    },
                    {
                        m_Type:BuildingType.AD,
                        m_Position:PositionType.Left,
                        m_Texture:"res/texture/building/l_b02.png",
                        m_Width:277,
                        m_Height:1112,
                        m_PositionOffset:[0,0,0]
                    },
                    {
                        m_Type:BuildingType.AD,
                        m_Position:PositionType.Left,
                        m_Texture:"res/texture/building/l_b03.png",
                        m_Width:545,
                        m_Height:428,
                        m_PositionOffset:[0,0,0]
                    },
                    {
                        m_Type:BuildingType.AD,
                        m_Position:PositionType.Left,
                        m_Texture:"res/texture/building/l_b04.png",
                        m_Width:472,
                        m_Height:651,
                        m_PositionOffset:[0,0,0]
                    },
                    {
                        m_Type:BuildingType.AD,
                        m_Position:PositionType.Left,
                        m_Texture:"res/texture/building/l_b05.png",
                        m_Width:307,
                        m_Height:693,
                        m_PositionOffset:[0,0,0]
                    },
                    {
                        m_Type:BuildingType.AD,
                        m_Position:PositionType.Left,
                        m_Texture:"res/texture/building/l_b06.png",
                        m_Width:378,
                        m_Height:293,
                        m_PositionOffset:[0,0,0]
                    },
                    {
                        m_Type:BuildingType.AD,
                        m_Position:PositionType.Left,
                        m_Texture:"res/texture/building/l_b07.png",
                        m_Width:250,
                        m_Height:585,
                        m_PositionOffset:[0,0,0]
                    },
                    {
                        m_Type:BuildingType.AD,
                        m_Position:PositionType.Left,
                        m_Texture:"res/texture/building/l_b08.png",
                        m_Width:220,
                        m_Height:740,
                        m_PositionOffset:[0,0,0]
                    },
                    {
                        m_Type:BuildingType.AD,
                        m_Position:PositionType.Left,
                        m_Texture:"res/texture/building/l_b09.png",
                        m_Width:314,
                        m_Height:680,
                        m_PositionOffset:[0,0,0]
                    },
                    {
                        m_Type:BuildingType.AD,
                        m_Position:PositionType.Right,
                        m_Texture:"res/texture/building/r_b01.png",
                        m_Width:413,
                        m_Height:359,
                        m_PositionOffset:[0,0,0]
                    },
                    {
                        m_Type:BuildingType.AD,
                        m_Position:PositionType.Right,
                        m_Texture:"res/texture/building/r_b02.png",
                        m_Width:321,
                        m_Height:375,
                        m_PositionOffset:[0,0,0]
                    },
                    {
                        m_Type:BuildingType.AD,
                        m_Position:PositionType.Right,
                        m_Texture:"res/texture/building/r_b03.png",
                        m_Width:472,
                        m_Height:413,
                        m_PositionOffset:[0,0,0]
                    },
                    {
                        m_Type:BuildingType.AD,
                        m_Position:PositionType.Right,
                        m_Texture:"res/texture/building/r_b04.png",
                        m_Width:338,
                        m_Height:598,
                        m_PositionOffset:[0,0,0]
                    },
                    {
                        m_Type:BuildingType.AD,
                        m_Position:PositionType.Right,
                        m_Texture:"res/texture/building/r_b05.png",
                        m_Width:264,
                        m_Height:1170,
                        m_PositionOffset:[0,0,0]
                    },
                    {
                        m_Type:BuildingType.AD,
                        m_Position:PositionType.Right,
                        m_Texture:"res/texture/building/r_b06.png",
                        m_Width:246,
                        m_Height:701,
                        m_PositionOffset:[0,0,0]
                    }
                ]
            }
        }
        ///////////////////////////////////////////////////////////////////////////////////////
        var GameConfig={
            m_RoadLength:500,
            m_RoadWidth:14,
            m_BuildingDistance:10,
            m_EnemyCarSpeed:100,
            m_CarMaxSpeed:200,
            m_CarHorizontalSpeed:10,
            m_CarAcceleration:100,
            m_CarPosition:[0,0,-20],
            m_CameraPosition:[0,5,-10],
            m_CarCrashSpeedOffset:20,
            m_CarRoadCount:3

        }
        ///////////////////////////////////////////////////////////////////////////////////////////
         //item
        var ITME_LIST={
            time:5,
            data:[
                [ItemType.None,ItemType.Car,ItemType.None],
                [ItemType.Gold,ItemType.None,ItemType.Gold],
                [ItemType.Gold,ItemType.Car,ItemType.None],
                [ItemType.Car,ItemType.None,ItemType.Gold],
                [ItemType.Gold,ItemType.None,ItemType.Car]
            ]
        }
        /////////////////////////////////////////////////////////////////////////////////////////////////
        var CacheType={
            Building:1,
            Gold:2,
            Car:3,
        }

        var CACHED_OBJECT=[];






        var renderer, scene, camera;
        var HEIGHT, WIDTH;
        
       
        //run time data
        var palyer_car=null;
        var move_left=false;
        var move_right=false;
        var move_forword=false;
        var forword_speed=0;
        var forword_speed_offset=0;
        var car_move_totle_length=0;
        var road_material_arg=null;
        var update_last_time=0;
        var left_ad_list=[];
        var enemy_car_list=[];
        var static_item_list=[];
        var item_refresh_time=0;
        var item_refresh_index=0;
        
        
        function init(){
            HEIGHT = window.innerHeight;  
            WIDTH = window.innerWidth;
            camera = new THREE.PerspectiveCamera( 60, WIDTH / HEIGHT, 1, 10000 );
			camera.position.set(GameConfig.m_CameraPosition[0],GameConfig.m_CameraPosition[1],GameConfig.m_CameraPosition[2]);
            camera.rotation.set(-Math.PI*0.1,0,0);
            //camera.position.set(0,5,8);
			scene = new THREE.Scene();
			//scene.background = new THREE.Color( 0x050505 );
            renderer = new THREE.WebGLRenderer({ 
                alpha: true, 
                antialias: true ,
                precision: 'highp'
            });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(WIDTH, HEIGHT);
            var size= renderer.getSize();
            container = document.getElementById('world');
            container.appendChild(renderer.domElement);
        }

        function createRoad(){
            LoadModel(GameResConfig.m_Road.m_Model,model=>{
                var scale = GameConfig.m_RoadLength/GameResConfig.m_Road.m_Height;
                road_material_arg = {
                    mapSize:{value:new THREE.Vector2(1,GameResConfig.m_Road.m_Height)},
                    scaleUV:{value:new THREE.Vector2(1,scale)},
                    offsetUV:{value:new THREE.Vector2(0,0),type:'v2'},
                    ColorMap:{ value: LoadTexture(GameResConfig.m_Road.m_Texture)}
                };
                var shaderMaterial = new THREE.ShaderMaterial( {
                    uniforms: road_material_arg,
                    vertexShader:document.getElementById('uvoffsetvertex').textContent,
                    fragmentShader: document.getElementById('costomfragment').textContent
                });
                model.traverse(function (child) {
                    if (child.isMesh) {
                        child.material = shaderMaterial;
                    }
                });
                
                
                var group = new THREE.Object3D();
                group.add(model);
                scene.add(group);
                model.scale.set(1,1,scale);
                model.position.set(0,0,-GameConfig.m_RoadLength);
            });
        }
        function createCar(src,clone_mode){
            var mesh = new THREE.Object3D();
            
            LoadModel(GameResConfig.m_Car.m_Model,model=>{
                if(clone_mode)model=model.clone();
                var shaderMaterial = new THREE.ShaderMaterial({
                    uniforms: {
                        ColorMap: { value: LoadTexture(src) }
                    },
                    vertexShader: document.getElementById('costomvertex').textContent,
                    fragmentShader: document.getElementById('costomfragment').textContent
                });
                model.traverse(function (child) {
                    if (child.isMesh) {
                        if (child.name != "pPlane1") child.material = shaderMaterial;
                    }
                });
                mesh.add(model);
                model.rotation.set(0,-Math.PI,0);
                model.scale.set(0.01,0.01,0.01);
            });
            return mesh;
        }
        function createBuilding(building){
            var mesh = new THREE.Object3D();
            var width=GameResConfig.m_Buildings.m_Scale*building.m_Width;
            var height=GameResConfig.m_Buildings.m_Scale*building.m_Height;
            var geometry = new THREE.PlaneGeometry( width, height, 1,1 );
            var shaderMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    ColorMap: { value: LoadTexture(building.m_Texture) }
                },
                vertexShader: document.getElementById('costomvertex').textContent,
                fragmentShader: document.getElementById('costomfragment').textContent,
                transparent: true
            });
            var model = new THREE.Mesh( geometry, shaderMaterial );
            mesh.add(model);
            if(building.m_Position == PositionType.Left){
                model.position.set(building.m_PositionOffset[0]-width*0.5,building.m_PositionOffset[1]+height*0.5,building.m_PositionOffset[2]);
                mesh.position.set(-GameConfig.m_RoadWidth*0.5,-5,-60);
            }
            else if(building.m_Position == PositionType.Right){
                model.position.set(building.m_PositionOffset[0]+width*0.5,building.m_PositionOffset[1]+height*0.5,building.m_PositionOffset[2]);
                mesh.position.set(GameConfig.m_RoadWidth*0.5,-5,-60);
            }
            return mesh;
        }
        function createGold(){
            var mesh = new THREE.Object3D();
            var geometry = new THREE.PlaneGeometry( GameResConfig.m_Gold.m_Size, GameResConfig.m_Gold.m_Size, 1,1 );
            var shaderMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    ColorMap: { value: LoadTexture(GameResConfig.m_Gold.m_Texture) }
                },
                vertexShader: document.getElementById('costomvertex').textContent,
                fragmentShader: document.getElementById('costomfragment').textContent,
                transparent: true
            });
            var model = new THREE.Mesh( geometry, shaderMaterial );
            mesh.add(model);
            model.position.set(0,GameResConfig.m_Gold.m_Size*0.5,0);
            return mesh;
        }
        function createBackground(){
            var geometry = new THREE.PlaneGeometry( GameResConfig.m_Background.m_Width, GameResConfig.m_Background.m_Height, 1,1 );
            var shaderMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    ColorMap: { value: LoadTexture(GameResConfig.m_Background.m_Texture) }
                },
                vertexShader: document.getElementById('costomvertex').textContent,
                fragmentShader: document.getElementById('costomfragment').textContent
            });
            var model = new THREE.Mesh( geometry, shaderMaterial );
            var offset = new THREE.Vector3(GameResConfig.m_Background.m_PositionOffset[0],GameResConfig.m_Background.m_PositionOffset[1],GameResConfig.m_Background.m_PositionOffset[2])
            model.position.set(offset.x,offset.y,offset.z-GameConfig.m_RoadLength);
            scene.add(model);
        }
        function createEnemyCar(){
            for(var i=0;i<3;i++){
                var road_start = parseInt(Math.random()*GameConfig.m_RoadLength);
                var len = GameConfig.m_RoadLength/GameConfig.m_CarRoadCount;
                for(var k=0;k<GameConfig.m_CarRoadCount;k++){
                    var z = GameConfig.m_RoadLength % (road_start + k*len);
                    var cache_data = {
                        m_Res: { m_Texture: GameResConfig.m_EnemyCars[0] },
                        m_Type: CacheType.Car,

                    }
                    var car = getCachedObject(cache_data);
                    car.m_CachedTag = cache_data;
                    car.visible = true;
                    car.position.set((i - 1) * GameConfig.m_RoadWidth / 3, 0, -z);
                    car.m_SpeedOffset = 0;
                    car.m_Type = ItemType.Car;
                    scene.add(car);
                    enemy_car_list.push(car);
                }
            }
        }
        function getCarSpeed(){
            return forword_speed+forword_speed_offset;
        }
        function getCachedObject(cache_data){
            var temp = CACHED_OBJECT[cache_data.m_Res.m_Texture];
            if(temp&&temp.length>0)return temp.pop();
            if(cache_data.m_Type == CacheType.Building)return createBuilding(cache_data.m_Res);
            if(cache_data.m_Type == CacheType.Car)return createCar(cache_data.m_Res.m_Texture,true);
            if(cache_data.m_Type == CacheType.Gold)return createGold(cache_data.m_Res.m_Texture);
            return null;
        }
        function pushCachedObject(obj){
            obj.visible=false;
            scene.remove(obj);
            var temp = CACHED_OBJECT[obj.m_CachedTag.m_Res.m_Texture];
            if(!temp){
                temp=[];
                CACHED_OBJECT[obj.m_CachedTag.m_Res.m_Texture]=temp;
            }
            temp.push(obj);
        }
        function chekcRunEnd(obj){
            return (obj.position.z - palyer_car.position.z)>10;
        }
        Math.lerp=function(a,b,t){
            return a+(b-a)*t;
        }
        function updateFollowCarPosition(frame){
            
            var car_speed=getCarSpeed();
            car_move_totle_length += car_speed * frame;
            //update road uv
            if(road_material_arg && move_forword){
                var d1 = Math.ceil(car_move_totle_length / GameConfig.m_RoadLength);
                var d2 = car_move_totle_length - d1*GameConfig.m_RoadLength;
                var uv_offset = d2/GameConfig.m_RoadLength;
                road_material_arg.offsetUV.value=new THREE.Vector2(0,-uv_offset);
                
            }
             //update left_ad
             var temp_left_ad_list=[];
            for(var i=0;i<left_ad_list.length;i++){
                var ad = left_ad_list[i];
                ad.position.z += frame * getCarSpeed();
                if(chekcRunEnd(ad)){
                   pushCachedObject(ad);
                }
                else {
                    temp_left_ad_list.push(ad);
                }
            }
            left_ad_list = temp_left_ad_list;

            //create new left ad
            var create_new_left_ad=left_ad_list.length==0;
            if(!create_new_left_ad){
                var ad = left_ad_list[left_ad_list.length-1];
                if((GameConfig.m_RoadLength + ad.position.z)>GameConfig.m_BuildingDistance){
                    create_new_left_ad =true;
                }
            }
            if(create_new_left_ad){
                var index = parseInt(Math.random()*GameResConfig.m_Buildings.m_Data.length);
                var cache_data={
                    m_Res:GameResConfig.m_Buildings.m_Data[index],
                    m_Type:CacheType.Building,
                    
                }
                var ad = getCachedObject(cache_data);
                ad.m_CachedTag=cache_data;
                ad.visible=true;
                left_ad_list.push(ad);
                ad.position.z=-GameConfig.m_RoadLength;
                scene.add(ad);
            }
            //update static item
            var temp_static_item=[];
            for(var i=0;i<static_item_list.length;i++){
                var item = static_item_list[i];
                item.position.z += frame * getCarSpeed();
                if(chekcRunEnd(item)){
                   pushCachedObject(item);
                }
                else {
                    temp_static_item.push(item);
                }
            }
            static_item_list = temp_static_item;

        }

        function update(frame){
           
            //update car
            if(palyer_car){
                if(move_left)palyer_car.position.x -= GameConfig.m_CarHorizontalSpeed*frame;
                if(move_right)palyer_car.position.x += GameConfig.m_CarHorizontalSpeed*frame;
                palyer_car.position.x = THREE.Math.clamp(palyer_car.position.x,-GameConfig.m_RoadWidth/3,GameConfig.m_RoadWidth/3);
                if(forword_speed < GameConfig.m_CarMaxSpeed){
                    if(move_forword)forword_speed += GameConfig.m_CarAcceleration*frame;
                    else if(forword_speed>0)forword_speed -= GameConfig.m_CarAcceleration*frame;
                    var s = (GameConfig.m_CarMaxSpeed*GameConfig.m_CarMaxSpeed - forword_speed*forword_speed)*0.5/GameConfig.m_CarAcceleration;
                    palyer_car.position.z = GameConfig.m_CarPosition[2]+s*0.02;
                }
                else{
                    palyer_car.position.z = GameConfig.m_CarPosition[2]
                    forword_speed = GameConfig.m_CarMaxSpeed;
                }
            }
            if(forword_speed_offset!=0){
                forword_speed_offset=Math.lerp(forword_speed_offset,0,frame);
            }

            if(move_forword)updateFollowCarPosition(frame);
           
            
            //update enemy car
            for(var i=0;i<enemy_car_list.length;i++){
                var item = enemy_car_list[i];
                if(item.m_SpeedOffset>0){
                    item.m_SpeedOffset = Math.lerp(item.m_SpeedOffset,0,0.1);
                }
                var self_seepd=GameConfig.m_EnemyCarSpeed+item.m_SpeedOffset;
                var player_speed=move_forword?getCarSpeed():0;
                var speed=self_seepd-player_speed;
                item.position.z -= frame * speed;
                if(item.position.z < -GameConfig.m_RoadLength){
                   //pushCachedObject(item);
                   item.position.z+=GameConfig.m_RoadLength;
                }
                else if(item.position.z>0){
                    item.position.z-=GameConfig.m_RoadLength;
                }
                else if((palyer_car.position.z > item.position.z) 
                && Math.abs(palyer_car.position.x - item.position.x)<GameResConfig.m_Car.m_Width
                && Math.abs(palyer_car.position.z - item.position.z)<GameResConfig.m_Car.m_Height){
                    //pushCachedObject(item);
                    forword_speed-=GameConfig.m_CarCrashSpeedOffset;
                    forword_speed=Math.max(forword_speed,0);
                    item.m_SpeedOffset=GameConfig.m_CarCrashSpeedOffset;
                }
            }
            //enemy_car_list = temp_car_list;
            if(move_forword){
                item_refresh_time += frame;
                if (item_refresh_time > (ITME_LIST.time / ITME_LIST.data.length)) {
                    item_refresh_time = 0;
                    var group = ITME_LIST.data[item_refresh_index];
                    for (var i = 0; i < group.length; i++) {
                        var type = group[i];
                        if (type == ItemType.Car) {
                            // var cache_data = {
                            //     m_Res: { m_Texture: GameResConfig.m_EnemyCars[0] },
                            //     m_Type: CacheType.Car,

                            // }
                            // var car = getCachedObject(cache_data);
                            // car.m_CachedTag = cache_data;
                            // car.visible = true;
                            // car.position.set((i - 1) * GameConfig.m_RoadWidth / 3, 0, -GameConfig.m_RoadLength);
                            // car.m_SpeedOffset=0;
                            // car.m_Type = ItemType.Car;
                            // scene.add(car);
                            // enemy_car_list.push(car);
                        }
                        else if(type == ItemType.Gold){
                            var cache_data = {
                                m_Res: { m_Texture: GameResConfig.m_Gold.m_Texture },
                                m_Type: CacheType.Gold,

                            }
                            var gold = getCachedObject(cache_data);
                            gold.m_CachedTag = cache_data;
                            gold.visible = true;
                            gold.position.set((i - 1) * GameConfig.m_RoadWidth / 3, 0, -GameConfig.m_RoadLength);

                            gold.m_Type = ItemType.Gold;
                            scene.add(gold);
                            static_item_list.push(gold);
                        }
                    }
                    item_refresh_index = (item_refresh_index + 1) % ITME_LIST.data.length;
                }
            }
            
        }
        function loop(time){
            update((time-update_last_time)*0.001);
            update_last_time=time;
            // 渲染场景
            renderer.render(scene, camera);
            // 重新调用 render() 函数
            requestAnimationFrame(loop);
        }
        function RigisterEvent(){
            document.addEventListener( 'keydown', onDocumentKeyDown );
			document.addEventListener( 'keyup', onDocumentKeyUp );
			// document.addEventListener( 'mousedown', onDocumentMouseDown );
			// document.addEventListener( 'mouseup', onDocumentMouseUp );
			// document.addEventListener( 'mousemove', onDocumentMouseMove );

			document.addEventListener( 'touchstart', onDocumentTouchStart );
			document.addEventListener( 'touchend', onDocumentTouchEnd );
			document.addEventListener( 'touchmove', onDocumentTouchMove );
        }
        function onDocumentTouchStart(event){
            if(event.clientY>HEIGHT/2){
                if(event.clientX<WIDTH/2)move_left=true;
                else move_right=true;
            }
        }
        function onDocumentTouchEnd(event){
            move_left=false;
            move_right=false;
        }
        function onDocumentTouchMove(event){

        }
        function onDocumentMouseDown(event){
            console.log(event);
            if(event.clientY>HEIGHT/2){
                if(event.clientX<WIDTH/2)move_left=true;
                else move_right=true;
            }
        }
        function onDocumentMouseUp(event){
            //console.log(event);
            move_left=false;
            move_right=false;
        }
        function onDocumentMouseMove(event){
            //console.log(event);
        }
        function onDocumentKeyDown(event){
            if(event.key == 'a'){
                move_left=true;
            }
            else if(event.key == 'd'){
                move_right=true;
            }
            else if(event.key == 'w'){
                move_forword=true;
            }
        }
        function onDocumentKeyUp(event){
            if(event.key == 'a'){
                move_left=false;
            }
            else if(event.key == 'd'){
                move_right=false;
            }
            else if(event.key == 'w'){
                move_forword=false;
                forword_speed-=0.1;
            }
        }
        init();
        
        RigisterEvent();
        loop(0);
        createBackground();
        createRoad();
        createEnemyCar();
        palyer_car=createCar(GameResConfig.m_Car.m_Texture);
        scene.add(palyer_car);

        // var building = createBuilding(GameResConfig.m_Buildings[0]);
        // scene.add(building);
    </script>
</body>
</html>